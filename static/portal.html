<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

    <title>GATOR</title>

    <link rel="stylesheet" type="text/css" href="../css/no-theme/jquery-ui-1.7.2.custom.css"/>
    <script type="text/javascript">
    window.svgns = 'http://www.w3.org/2000/svg';
    </script>
    <!-- <script type="text/javascript" src="../js/svgweb/svg-uncompressed.js" data-path="../js/svgweb/"></script> -->

    <!-- <script type="text/javascript" src="../js/maschup.min.js"></script> -->

    <script type="text/javascript" src="../js/maschup.services.min.js"></script>

    <script type="text/javascript" src="../js/lib/gomap.js"></script>
    <script type="text/javascript" src="../js/lib/SequenceRenderer.js"></script>
    <script type="text/javascript" src="../js/lib/CondensedSequenceRenderer.js"></script>
    
    <script type="text/javascript" charset="utf-8" src="http://code.jquery.com/jquery-1.4.1.js"></script>

    <script type="text/javascript" src="../js/jquery-ui-1.7.2.min.js"></script>

    <style type="text/css">
        body {
            font-family: Verdana, Helvetica, Arial, sans-serif;
            font-size: 11pt;
        }
        h1 span {
            display: block;
            position: absolute;
            top: 0px;
            left: 0px;
        }
        .track {
            position: relative;
        }
        .mask {
            display: none;
        }

        .active_layer .mask {
            display: block;
        }

        .mask:hover {
            opacity: 0.1;
        }

        #sequence_controllers > li {
            display: none;
        }


        #sequence_controllers {
            position: relative;
            display: block;
            padding: 0px;
            list-style: none;
            overflow: auto;            
            left: 0em;
            right: 0px;
            bottom: 10px;
            top: 10px;
            margin: 0px;
        }
        
        #sequence_control {
            position: relative;
            width: 300px;
            height: 200px;
        }

        #zoom_controls {
            left: 0px;
            bottom: 0px;
            position: relative;
        }

        #suba_results {
            position: relative;
            width: 45%;
            left: 10px;
            top: 0px;
        }
        
        #suba_controller {
            position: relative;
            left: 3em;
            width: 100px;
        }
        
        #atproteome_map {
            position: absolute;
            width: 45%;
            right: 10px;
            top: 0px;
        }
        
        #agi_input, #agi_input input[type='text'] {
            font-size: 30pt;
            border: 0px;
        }
        /*
        #controls {
            font-size: 30pt;
            width: 1em;
            height: 1em;
            background: #dddddd;
        }
        
        #controls span {
            display: none;
        }
        */
    </style>
</head>

<body>
<div style="position: absolute; top: 10px; right: 10px; width: 50%;">
<h1 style="position: absolute; right: 0px; top: 0px; margin: 0px; width: 100%;"><span>MASCP AggreGATOR</span><img style="height: 50px; top: 50%; right: 0px; position: absolute;" src="gator.png" /></h1>
</div>
<div id="agi_input" style="height: 70px; margin-bottom: 10px; position: relative;">
    <label for="agi">AGI </label><input size="12" id="agi" type="text" name="agi" value="at3g15450.1"/><button id="contols"><span>Settings</span></button>
</div>
<div id="sequence_control">
<ul style="margin-bottom: 10px;" id="sequence_controllers">
    <li id="phosphat_experimental"><input type="checkbox"/> PhosPhAT experimental</li>
    <li id="phosphat_theoretical"><input type="checkbox"/> PhosPhAT theoretical</li>
    <li id="promex_placeholder"><input type="checkbox"/> ProMeX</li>
    <li id="atproteome_placeholder"><input type="checkbox"/> ATProteome</li>
    <li id="hydropathy"><input type="checkbox"/> Hydropathy plot</li>
    <li id="suba_ms" class="ms"><div style="position: relative; left: 0px; top: 0px; float: left; background-color: #ff0000; width: 1em; height: 1em;"></div><input class="ms" type="checkbox"/> MS</li>
    <li id="suba_gfp" class="gfp"><div style="position: relative; left: 0px; top: 0px; float: left; background-color: #00ff00; width: 1em; height: 1em;"></div><input class="gfp" type="checkbox"/> GFP</li>
</ul>
</div>
<div style="position: relative;">
<div style="overflow: hidden; width: auto; height: 100%;">
<div id="condensed_container"></div>
<div id="hydropathy_container" style="margin-bottom: 10px;">
</div>
</div>
</div>
<div id="sequence_container" style="font-family: monospace;">
</div>
<div style="position: relative;">
<div id="suba_results">
</div>
<div id="atproteome_map"></div>
</div>
<script type="text/javascript">
//<[CDATA[ 
    window.onload = null;
    
    jQuery(document).ready(function() {        
        if (MASCP.IE) {
            MASCP.renderer = new MASCP.SequenceRenderer(document.getElementById('sequence_container'));
        } else {
            MASCP.renderer = new MASCP.CondensedSequenceRenderer(document.getElementById('condensed_container'));
            var zoom_controls = GOMap.Diagram.addZoomControls(MASCP.renderer);
            zoom_controls.id = 'zoom_controls';        
            jQuery('#sequence_control').append(zoom_controls);
            if (zoom_controls.style.height == '100%') {
                jQuery('#sequence_controllers').css('left','3em').css('position','relative');
                zoom_controls.style.position = 'absolute';
                zoom_controls.style.height = '75%';
                zoom_controls.style.top = '0px';
            }
            zoom_controls.style.zIndex = 2;
            var dragger = new GOMap.Diagram.Dragger();
//            dragger.targetElement = document.getElementById('condensed_container').parentNode;
            MASCP.renderer.zoom = 0.81;
            MASCP.renderer.padding = 10;

            jQuery(MASCP.renderer).bind('sequenceChange', function() {
                var zoomFactor = document.width / (2 * MASCP.renderer.sequence.length);
                MASCP.renderer.defaultZoom = zoomFactor;
                MASCP.renderer.zoom = zoomFactor;
                dragger.applyToElement(MASCP.renderer._canvas);
                GOMap.Diagram.addTouchZoomControls(MASCP.renderer, MASCP.renderer._canvas);
            });
        }
        
        var tissue_map = null;
        
        if (typeof GOMap != 'undefined') {
            var map_container = jQuery('<div style="position: relative; height: 0px; width: 100%; margin-bottom: 2px; overflow: hidden;"></div>');
            tissue_map = new GOMap.Diagram('tissue.svg', { 'load' : (function() {
                map_container.css({'height': '100%','overflow':'visible'});
            })});

            tissue_map.appendTo(map_container[0]);
            jQuery('#atproteome_map').append(map_container);                
        }
        
        var rendering_readers = [];
        
        if(!Array.indexOf){
            Array.prototype.indexOf = function(obj){
                for(var i=0; i<this.length; i++){
                    if(this[i]==obj){
                        return i;
                    }
                }
                return -1;
            }
        }
        
        jQuery(MASCP.renderer).bind('resultsRendered',function(renderer) {

            rendering_readers.splice(rendering_readers.indexOf(renderer),1);

            if (rendering_readers.length > 0) {
                return;
            }
            MASCP.renderer.createLayerCheckbox('phosphat_theoretical',jQuery('#phosphat_theoretical input')[0],true);
            MASCP.renderer.createLayerCheckbox('phosphat_experimental',jQuery('#phosphat_experimental input')[0],true);      
            if (MASCP.getGroup('promex_experimental').size() > 1) {
                MASCP.renderer.createLayerCheckbox('promex_controller',jQuery('#promex_placeholder input')[0],true);      
            } else {
                MASCP.renderer.createGroupCheckbox('promex_experimental',jQuery('#promex_placeholder input')[0],true);                
            }
            
            if (MASCP.getGroup('atproteome').size() > 1) {
                MASCP.renderer.createLayerCheckbox('atproteome_controller',jQuery('#atproteome_placeholder input')[0],true);
            } else {
                MASCP.renderer.createGroupCheckbox('atproteome',jQuery('#atproteome_placeholder input')[0],true);
            }
            
            MASCP.renderer.createLayerCheckbox('hydropathy',jQuery('#hydropathy input')[0],true);            
            
            var tweak_track_order = function(array) {
                if (array.splice && array.indexOf) {
                    if (MASCP.getGroup('atproteome').size() > 1) {
                        array.splice(array.indexOf('atproteome_placeholder'),0,'atproteome_controller','atproteome');
                    } else {
                        array.splice(array.indexOf('atproteome_placeholder'),0,'atproteome');                        
                    }
                    if (MASCP.getGroup('promex_experimental').size() > 1) {
                        array.splice(array.indexOf('promex_placeholder'),0,'promex_controller','promex_experimental');
                    } else {
                        array.splice(array.indexOf('promex_placeholder'),0,'promex_experimental');
                    }
                }
                return array;
            };
            
            MASCP.renderer.trackOrder = tweak_track_order(jQuery('#sequence_controllers').sortable({
                update: function(event, ui) {
                    if (MASCP.renderer.trackOrder) {
                        MASCP.renderer.trackOrder = tweak_track_order(jQuery('#sequence_controllers').sortable('toArray'));
                    }
                    if (MASCP.renderer.setTrackOrder) {
                        MASCP.renderer.setTrackOrder(tweak_track_order(jQuery('#sequence_controllers').sortable('toArray')));
                    }
                },
            }).sortable('toArray'));

            var a_dialog = jQuery('#sequence_control').dialog({resizable: false, autoOpen: false, draggable: false, title: "Data", width: '300px', position:['50%','50%'], zIndex: 5000});
            jQuery(MASCP.renderer._Navigation).unbind('click').bind('click',function() {
                if (! a_dialog.dialog('isOpen')) {
                    a_dialog.dialog('open');// 'option', 'position', [this.offsetLeft+this.width, this.offsetTop+this.clientHeight] ).dialog('open');
                } else {
                    a_dialog.dialog('close');
                }
            });
            
            
            if (MASCP.renderer.setTrackOrder) {
                MASCP.renderer.setTrackOrder(MASCP.renderer.trackOrder);                
            }
        });
        
        jQuery(MASCP).bind('layerRegistered', function(e,layer) {

            var mouse_out_func = function(e,ev) {
                tissue_map.hideAllKeywords();
            };
            
            if (layer.group && layer.group.name == 'atproteome') {
                jQuery(layer).bind('click',function(e,orig_event,source) {
                    tissue_map.toggleKeyword(layer.data['po']);
                    // if (tissue_map.toggleKeyword(layer.data['po'])) {
                    //     MASCP.renderer.setHighlight(layer,true);
                    // } else {
                    //     MASCP.renderer.setHighlight(layer,false);                        
                    // }
                });
            }
            if (layer.name == 'atproteome_controller') {
                var is_highlighted = false;
                var is_open = false;
                
                jQuery(layer).bind('click',function(e,orig_event,source) {
                    is_highlighted = ! is_highlighted;
                    
//                    MASCP.renderer.setHighlight(layer,is_highlighted);
                    MASCP.getGroup('atproteome').eachLayer(function() {
                        if (is_highlighted) {
                            tissue_map.showKeyword(this.data['po']);
                                // MASCP.renderer.setHighlight(this,tissue_map.showKeyword(this.data['po']) && is_open);
                        } else {
                            tissue_map.hideKeyword(this.data['po']);
//                            MASCP.renderer.setHighlight(this,false);                                
                        }
                    });
                });
                jQuery(layer).bind('longclick',function(e,orig_event,source) {
                    is_open = ! is_open;
                    MASCP.getGroup('atproteome').eachLayer(function() {
                        if (is_open && is_highlighted && tissue_map.showKeyword(this.data['po'])) {
//                            MASCP.renderer.setHighlight(this,true);
                        } else {
//                            MASCP.renderer.setHighlight(this,false);                            
                        }
                    });
                });
            }
        });

        jQuery(MASCP.renderer).bind('sequenceChange',function() {
            if (MASCP.renderer.sequence == '') {
                return;
            }
            
            var agi = jQuery('#agi')[0].value;
            MASCP.renderer.reset();
            if (MASCP.renderer.createHydropathyLayer) {
                MASCP.renderer.createHydropathyLayer(4);
                jQuery('#hydropathy').show();
            }
            
            if (MASCP.SubaReader.existing_map) {
                log("Removing existing map");
                MASCP.SubaReader.existing_map.destroy();
                MASCP.SubaReader.existing_map = null;
            }
    
            var suba = new MASCP.SubaReader(agi);
            suba.retrieve();
            jQuery(suba).bind('resultReceived',function() {
                jQuery('#suba_results').text('');
                jQuery('#suba_results').append(this.result.render());               
                if (this.result._map) {
                    MASCP.SubaReader.existing_map = this.result._map;
                    var controller = this.result.mapController(jQuery('#sequence_controllers')[0]);
                    if (this.result.getMassSpecLocalisation()) {
                        jQuery('#sequence_control li.ms').show();
                    }
                    if (this.result.getGfpLocalisation()) {
                        jQuery('#sequence_control li.gfp').show();
                    }
                }
            });

            var phosphat = new MASCP.PhosphatReader(agi,'../proxy.pl');
            phosphat.registerSequenceRenderer(MASCP.renderer);
            rendering_readers.push(phosphat);
            phosphat.bind('resultReceived',function() {
                if (this.result.getAllExperimentalPositions().length > 0) {                 
                    jQuery('#phosphat_experimental').show();
                } else if (this.result.getAllPredictedPositions().length > 0) {
                    jQuery('#phosphat_theoretical').show();                 
                }
            });
            jQuery('#phoshpat_experimental input').attr('checked',false);
            jQuery('#phosphat_theoretical input').attr('checked',false);            
            jQuery('#phosphat_experimental').hide();
            jQuery('#phosphat_theoretical').hide();
            phosphat.retrieve();
            
            var promex = new MASCP.PromexReader(agi);
            promex.registerSequenceRenderer(MASCP.renderer);
            rendering_readers.push(promex);
            promex.bind('resultReceived',function() {
                jQuery(MASCP.getLayer('promex_controller')).each(function() {
                    if (MASCP.renderer.applyStyle) {
                        MASCP.renderer.applyStyle(this.name,'cursor: pointer');
                    }
                });

                if (this.result.getPeptides().length > 0) {
                    jQuery('#promex_placeholder').show();
                }
            });
            jQuery('#promex_placeholder').hide();
            promex.retrieve();

            var atproteome = new MASCP.AtProteomeReader(agi);
            atproteome.registerSequenceRenderer(MASCP.renderer);
            rendering_readers.push(atproteome);
            atproteome.bind('resultReceived',function() {

                if (this.result == null) {
                    return;
                }
                
                jQuery(MASCP.getLayer('atproteome_controller')).each(function() {
                    if (MASCP.renderer.applyStyle) {
                        MASCP.renderer.applyStyle(this.name,'cursor: pointer');
                    }
                });
                jQuery('#atproteome_placeholder').show();
            });
            jQuery('#atproteome_placeholder').hide();
            atproteome.retrieve();
        });
        
        // Trigger the change event on page load
        jQuery('#agi').trigger('change');
    });

    jQuery('#agi').bind('change',function() {
        var agi = this.value;
        if (agi.length < 1) {
            return;
        }

        for (var groupname in MASCP.groups) {
            MASCP.renderer.hideGroup(groupname);
        }
        
        for (var layername in MASCP.layers) {
            MASCP.renderer.hideLayer(layername);
        }
        
        var reader = new MASCP.TairReader(agi,'../proxy.pl');
        jQuery(reader).bind('resultReceived',function() {
            if (this.result.getSequence() == '') {
                return;
            }
            MASCP.renderer.setSequence(this.result.getSequence());
        });
        reader.retrieve();
    });
//]]>
</script>
</body>
</html>
