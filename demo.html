<!DOCTYPE html>
<html>
<head>
	<script src="dist/js/mascp-jstools.js"></script>
	<title>Demo</title>
  <style type="text/css">
    #fixed {
      --fill-viewer: 'yes';
      width: 685px;
      height: 400px;
    }
    #static {
      width: 400px;
      height: 200px;
    }
  </style>
</head>
<body>
  <x-protviewer interactive ></x-protviewer>
  <x-protviewer selecting interactive ></x-protviewer>
<!--   <x-protviewer id="fixed" interactive ></x-protviewer>
  <x-protviewer id="static"></x-protviewer>
 -->
 <!-- <x-geneviewer geneid="2590" interactive></x-geneviewer> -->
<script>


window.onload = function() {
	(function(global) {

let retrieve_uniprot = function(uniprot) {
  MASCP.GATOR_CLIENT_ID='fNED1UGvPaP0XlrcEvWsHXIODIKy6WVB';
  MASCP.GatorDataReader.server = 'https://glycodomain.glycomics.ku.dk';
  MASCP.GatorDataReader.anonymous = true;
  return MASCP.GatorDataReader.authenticate().then(function(url_base) {
    let a_reader = new MASCP.UniprotReader();
    return new Promise((resolve,reject) => {
    a_reader.retrieve(uniprot, function(err) {
      resolve(this.result._raw_data.data[0]);
    });
    });
  });
};


let show_uniprot = function(renderer,uniprot) {
  return retrieve_uniprot(uniprot).then( seq => {
    renderer.setSequence(seq);
  });
};

let show_data = function(uniprot) {
  MASCP.GATOR_CLIENT_ID='fNED1UGvPaP0XlrcEvWsHXIODIKy6WVB';
  MASCP.GatorDataReader.server = 'https://glycodomain.glycomics.ku.dk';
  MASCP.GatorDataReader.anonymous = true;
  return MASCP.GatorDataReader.authenticate().then(function(url_base) {
    let a_reader = MASCP.GatorDataReader.createReader('glycodomain');
    a_reader.datasetname = 'glycodomain';
    return new Promise((resolve,reject) => {
      a_reader.retrieve(uniprot, function(err) {
        resolve(this.result);
      });
    });
  });
};

global.showData = show_data;

global.showUniprot = show_uniprot;
global.retrieveUniprot = retrieve_uniprot;
  
})(window);
  

let guid = () => {
  let s4 = () => {
    return Math.floor((1 + Math.random()) * 0x10000)
      .toString(16)
      .substring(1);
  };
  return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
};

let make_track = (id,fullname,scale) => {
  let a_track = document.createElement('x-gatortrack');
  a_track.setAttribute('name',id);
  a_track.setAttribute('fullname',fullname);
  if (scale) {
    a_track.setAttribute('scale',scale);
  }
  return a_track;
};


let show_sequence = function(el,uniprot,base_pos,genomic_base) {
  let start_promise = genomic_base ? el.ready : showUniprot(el.renderer,uniprot);

  let first_lay_id = guid();

  el.appendChild(make_track( first_lay_id, 'Proteintrack', uniprot ));

  let second_lay_id = guid();

  el.appendChild(make_track( second_lay_id, 'AnotherDataset', genomic_base ? 'genomic' : uniprot ));


  start_promise.then( () => {
    let renderer = el.renderer;
    el.refreshTracks();

    renderer.renderObjects(first_lay_id,[{aa: base_pos, type: 'marker', options: { bare_element:true,
    height: 18,
    offset: -1,
    content:"#sugar_man"} }]);

    renderer.renderObjects(second_lay_id,[{aa: genomic_base ? genomic_base : base_pos+10, type: 'marker', options: { bare_element:true,
    height: 18,
    offset: -1,
    content:"#sugar_gal"} }]);

    el.fitToZoom();
    renderer.refresh();
    renderer.zoom -= 0.01;
  });
};

let do_clustal = function(el,uniprota,uniprotb,base_pos) {
  let runner = MASCP.ClustalRunner.EmulatedClustalRunner(el.renderer);

  let first_lay_id = guid();
  el.appendChild(make_track( first_lay_id, 'Seq0dat', 'seq0' ));

  let second_lay_id = guid();
  el.appendChild(make_track( second_lay_id, 'Seq1dat', 'seq1' ));


  Promise.all( [ retrieveUniprot(uniprota), retrieveUniprot(uniprotb) ]).then( seqs => {
    let renderer = el.renderer;
    seqs[1] = (seqs[1].slice(0,10) + '----------' + seqs[1].slice(20)).slice(0,100)+'MMMMMMMMMM';
    seqs[0] = seqs[0].slice(0,100)+'----------';

    runner.sequences = seqs;

    runner.bind('requestComplete', () => {

      el.refreshTracks();

      renderer.selecting =true;

      runner.result.alignToSequence(0);


      renderer.renderObjects(first_lay_id,[{aa: base_pos, type: 'marker', options: { bare_element:true,
      height: 18,
      offset: -1,
      content:"#sugar_man"} },{aa: base_pos+1, type: 'marker', options: { bare_element:true,
      height: 18,
      offset: -1,
      content:"#sugar_man"} },{aa: base_pos+15, type: 'marker', options: { bare_element:true,
      height: 18,
      offset: -1,
      content:"#sugar_man"} }]);


      renderer.renderObjects(second_lay_id,[{aa: base_pos+1, type: 'marker', options: { bare_element:true,
      height: 18,
      offset: -1,
      content:"#sugar_gal"} },{aa: base_pos+2, type: 'marker', options: { bare_element:true,
      height: 18,
      offset: -1,
      content:"#sugar_gal"} },{aa: base_pos+5, type: 'marker', options: { bare_element:true,
      height: 18,
      offset: -1,
      content:"#sugar_gal"} }]);

      el.fitToZoom();
      renderer.refresh();

    });

    runner.retrieve();


  });
};

show_sequence(document.querySelectorAll('x-protviewer')[0],'Q14112',200);
do_clustal(document.querySelectorAll('x-protviewer')[1],'Q14112','Q14112',11);
// show_sequence(document.querySelectorAll('x-geneviewer')[0],'Q10471',200,230382000);


//230379000

};
</script>
</body>
</html>